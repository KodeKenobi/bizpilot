<!DOCTYPE html>
<html>
  <head>
    <title>PDF to HTML - {{ filename }}</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
      }

      .header {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        margin: 0 0 10px 0;
        color: #333;
      }

      .header p {
        margin: 0;
        color: #666;
      }

      .pdf-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .pdf-page {
        position: relative;
        margin: 20px auto;
        background: white;
        border: 1px solid #ddd;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transform-origin: top left;
      }

      .text-line {
        position: relative;
        white-space: nowrap;
      }

      .text-span {
        position: absolute;
        white-space: nowrap;
      }

      .editable-text {
        cursor: pointer;
        border: 1px solid transparent;
        padding: 2px;
        border-radius: 3px;
      }

      .editable-text:hover {
        border-color: #007bff;
        background-color: rgba(0, 123, 255, 0.1);
      }

      .editable-image {
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 3px;
      }

      .editable-image:hover {
        border-color: #007bff;
      }

      .edit-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .edit-modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 500px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .edit-modal h3 {
        margin-top: 0;
        color: #333;
      }

      .edit-modal input,
      .edit-modal textarea {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .edit-modal textarea {
        height: 100px;
        resize: vertical;
      }

      .edit-modal-buttons {
        text-align: right;
        margin-top: 20px;
      }

      .edit-modal button {
        padding: 10px 20px;
        margin-left: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .save-btn {
        background: #28a745;
        color: white;
      }

      .save-btn:hover {
        background: #218838;
      }

      .cancel-btn {
        background: #6c757d;
        color: white;
      }

      .cancel-btn:hover {
        background: #5a6268;
      }

      .image-upload {
        margin: 10px 0;
      }

      .image-upload input[type="file"] {
        display: block;
        margin: 10px 0;
      }

      .page-controls {
        text-align: center;
        padding: 20px;
        background: white;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .page-controls button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 0 5px;
        border-radius: 4px;
        cursor: pointer;
      }

      .page-controls button:hover {
        background: #0056b3;
      }

      .page-controls button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .zoom-controls {
        display: inline-block;
        margin-left: 20px;
      }

      .zoom-controls input {
        width: 60px;
        margin: 0 5px;
      }

      .download-section {
        text-align: center;
        padding: 20px;
        background: white;
        border-radius: 8px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .download-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }

      .download-btn:hover {
        background: #218838;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>PDF Converted to HTML</h1>
      <p>File: {{ filename }} | Pages: {{ pages|length }}</p>
    </div>

    <div class="page-controls">
      <button id="prevPage" onclick="changePage(-1)">Previous</button>
      <span id="pageInfo">Page 1 of {{ pages|length }}</span>
      <button id="nextPage" onclick="changePage(1)">Next</button>

      <div class="zoom-controls">
        <button onclick="changeZoom(0.5)">50%</button>
        <button onclick="changeZoom(1)">100%</button>
        <button onclick="changeZoom(1.5)">150%</button>
        <button onclick="changeZoom(2)">200%</button>
      </div>
    </div>

    <div class="pdf-container">
      {% for page in pages %}
      <div
        class="pdf-page"
        id="page-{{ loop.index }}"
        style="width: {{ page.width }}px; height: {{ page.height }}px; {% if loop.index > 1 %}display: none;{% endif %}"
      >
        {{ page.html|safe }}
      </div>
      {% endfor %}
    </div>

    <div class="download-section">
      <button
        onclick="saveEdits()"
        class="download-btn"
        style="background: #007bff; margin-right: 10px"
      >
        Save Edits
      </button>
      <a href="/" class="download-btn">Convert Another PDF</a>
    </div>

    <div id="editModal" class="edit-modal">
      <div class="edit-modal-content">
        <h3 id="modalTitle">Edit Content</h3>
        <div id="modalBody">
          <input type="text" id="editInput" placeholder="Enter new text" />
        </div>
        <div class="edit-modal-buttons">
          <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
          <button class="save-btn" onclick="saveEdit()">Save</button>
        </div>
      </div>
    </div>

    <script>
      let currentPage = 1;
      const totalPages = {{ pages|length }};
      let currentZoom = 1;
      let edits = [];
      let currentEditElement = null;
      let currentEditType = null;

      function changePage(direction) {
        const newPage = currentPage + direction;
        if (newPage >= 1 && newPage <= totalPages) {
          document.getElementById(`page-${currentPage}`).style.display = 'none';
          currentPage = newPage;
          document.getElementById(`page-${currentPage}`).style.display = 'block';
          document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;

          document.getElementById('prevPage').disabled = currentPage === 1;
          document.getElementById('nextPage').disabled = currentPage === totalPages;
        }
      }

      function changeZoom(zoom) {
        currentZoom = zoom;
        const pages = document.querySelectorAll('.pdf-page');
        pages.forEach(page => {
          page.style.transform = `scale(${zoom})`;
          page.style.transformOrigin = 'top left';
        });
      }

      function openEditModal(element, type) {
        currentEditElement = element;
        currentEditType = type;
        const modal = document.getElementById('editModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const editInput = document.getElementById('editInput');

        if (type === 'text') {
          modalTitle.textContent = 'Edit Text';
          modalBody.innerHTML = '<input type="text" id="editInput" placeholder="Enter new text">';
          editInput.value = element.textContent;
        } else if (type === 'image') {
          modalTitle.textContent = 'Replace Image';
          modalBody.innerHTML = `
            <div class="image-upload">
              <p>Current image:</p>
              <img src="${element.src}" style="max-width: 200px; max-height: 150px; border: 1px solid #ddd;">
              <p>Upload new image:</p>
              <input type="file" id="imageFile" accept="image/*">
            </div>
          `;
        }

        modal.style.display = 'block';
      }

      function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        currentEditElement = null;
        currentEditType = null;
      }

      function saveEdit() {
        if (currentEditType === 'text') {
          const newText = document.getElementById('editInput').value;
          if (newText !== currentEditElement.textContent) {
            edits.push({
              type: 'text',
              page: currentPage,
              old_text: currentEditElement.dataset.text,
              new_text: newText
            });
            currentEditElement.textContent = newText;
            currentEditElement.dataset.text = newText;
          }
        } else if (currentEditType === 'image') {
          const fileInput = document.getElementById('imageFile');
          if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
              edits.push({
                type: 'image',
                page: currentPage,
                image_id: parseInt(currentEditElement.dataset.imageId),
                image_data: e.target.result
              });
              currentEditElement.src = e.target.result;
            };
            reader.readAsDataURL(file);
          }
        }

        closeEditModal();
      }

      function saveEdits() {
        if (edits.length === 0) {
          alert('No edits to save');
          return;
        }

        fetch(`/save_edits/{{ filename }}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(edits)
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            alert('Edits saved successfully!');
            edits = [];
          } else {
            alert('Error saving edits: ' + data.message);
          }
        })
        .catch(error => {
          alert('Error saving edits: ' + error);
        });
      }

      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.editable-text').forEach(element => {
          element.addEventListener('click', function() {
            openEditModal(this, 'text');
          });
        });

        document.querySelectorAll('.editable-image').forEach(element => {
          element.addEventListener('click', function() {
            openEditModal(this, 'image');
          });
        });

        document.getElementById('prevPage').disabled = true;
        if (totalPages === 1) {
          document.getElementById('nextPage').disabled = true;
        }
      });

      window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target === modal) {
          closeEditModal();
        }
      }
    </script>
  </body>
</html>
